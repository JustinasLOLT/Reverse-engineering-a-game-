var agi={config:{text:{},errorCode:{},flashAgiAction:{},jsAgiEvents:{SHOW_STOREFRONT:"showStorefront",HIDE_STOREFRONT:"hideStorefront",PURCH_VERIFY_FAILED:"purchaseVerifyFailed"},analyticPageUrls:{}},trackPageview:function(pageUrl){pageUrl&&_gaq&&"function"==typeof _gaq.push&&_gaq.push(["_trackPageview",pageUrl])},console:{log:function(message){this._display("log",arguments)},warn:function(message){this._display("warn",arguments)},error:function(message){this._display("error",arguments)},_display:function(level,message){"armorgames.com"===location.hostname&&-1===location.search.toLowerCase().indexOf("agi_debug=1")&&-1===location.search.toLowerCase().indexOf("questdb")||console&&"function"==typeof console[level]&&console[level]("â˜… JS_AGI: ",message)}},v2:{},ping:function(){"use strict";agi.console.log("Remote ping")},setIframeDimensions:function(dimensions){"use strict";jQuery("#gamefilearea,#gamefilearea iframe").animate({width:dimensions.width+"px",height:dimensions.height+"px"},{duration:400,queue:!1,easing:"easeOutQuad"}),jQuery("#gamefilearea").animate({"margin-left":parseInt(Math.round((953-dimensions.width)/2))+"px"},{duration:400,queue:!1,easing:"easeOutQuad"})},updateUserQuest:function(args){"use strict";var $questElem=jQuery("li[data-dev-id='"+args.questKey+"']");$questElem.length?parseInt($questElem.attr("data-target-value"),10)===parseInt(args.currentValue,10)?$questElem.is(":not(.completed)")?($questElem.removeClass("in-progress loading").addClass("completed"),questNotifier.show($questElem.find("img#"+args.questKey).attr("src"))):agi.console.log("Quest already completed for developer ID "+args.questKey):agi.console.log("Quest current value not equal to target for developer ID "+args.questKey,parseInt(args.currentValue,10),parseInt($questElem.attr("data-target-value"),10)):agi.console.warn("Could not find quest on page with developer ID "+args.questKey)}};agi.v2.config=agi.config,agi.v2.console=agi.console,jQuery.extend(!0,agi.v2.config,{flashMovieObjectId:"gamefile",flashMovieEmbedId:"gamefileEmbed",flashAgiCallbackName:"flashCallback",flashAgiAction:{RECEIVE_ECHO:"receiveEcho",COMPLETE_PURCHASE:"completePurchase",CANCEL_PURCHASE:"cancelPurchase",FAILED_PURCHASE:"failedPurchase"},vendorAgiAction:{COMPLETE_PURCHASE:"completePurchase",CANCEL_PURCHASE:"cancelPurchase",FAILED_PURCHASE:"failedPurchase"},vendorType:{FLASH:"flash",WEBSITE:"website"},jsAgiEvents:{ECHO:"echo",SERVICE_CALL:"serviceCall",QUEST_UPDATE:"questUpdate",CONTENT_CONSUME:"contentConsume"}}),agi.v2.currentVendorType=agi.v2.config.vendorType.FLASH,agi.v2._vendorElement=null,agi.v2.setVendor=function(vendorType){for(var type in agi.v2.config.vendorType)if(agi.v2.config.vendorType[type]===vendorType)return agi.v2.currentVendorType=vendorType,!0;return!1},agi.v2.setVendorElement=function(vendorElement){return agi.v2._vendorElement=vendorElement,!0},agi.v2.sendMessage=function(message){return this.console.log("Received message from "+agi.v2.currentVendorType+" (action,payload)",message.action,message.payload),this._validateMessageAction(message.action)?(jQuery(agi.v2).trigger(message.action,[message.action,message.payload]),jQuery(agi.v2).trigger("all",[message.action,message.payload]),!0):(this.console.log("Failed to find corresponding event for given action"),!1)},agi.sendMessage=function(message){agi.v2.sendMessage({action:agi.config.jsAgiEvents.QUEST_UPDATE,payload:jQuery.parseJSON(message)})},agi.v2._validateMessageAction=function(action){for(var eventName in this.config.jsAgiEvents)if(action===this.config.jsAgiEvents[eventName])return this.console.log("Action is valid",action),!0;return this.console.warn("Action is invalid",action),!1},agi.v2._registerCallback=function(action,callback){jQuery(agi.v2).on(action,callback)},agi.v2._findFlashElement=function(){var element;return agi.v2._vendorElement&&agi.v2.currentVendorType===agi.v2.config.vendorType.FLASH?agi.v2._vendorElement:("function"==typeof document.getElementById(this.config.flashMovieObjectId)[this.config.flashAgiCallbackName]?element=document.getElementById(this.config.flashMovieObjectId):"function"==typeof document.getElementById(this.config.flashMovieEmbedId)[this.config.flashAgiCallbackName]?element=document.getElementById(this.config.flashMovieEmbedId):agi.console.error("Failed to find Flash callback on either object or embed"),element)},agi.v2.sendToAgi=function(action,payload){"use strict";switch(this.console.log("Sending message to "+agi.v2.currentVendorType+" (action,payload)",action,payload),agi.v2.currentVendorType){case agi.v2.config.vendorType.WEBSITE:return void jQuery(agi.v2).trigger(action,[action,payload]);case agi.v2.config.vendorType.FLASH:var flashElem=this._findFlashElement();agi.v2.setVendorElement(flashElem);try{flashElem[this.config.flashAgiCallbackName]({action:action,payload:payload})}catch(err){agi.console.error("sendToAgi error (flash)",err)}return}},jQuery(agi.v2).bind(agi.config.jsAgiEvents.ECHO,function(e,action,payload){agi.v2.sendToAgi(agi.config.flashAgiAction.RECEIVE_ECHO,payload)});var userAchievementProgress=[];jQuery(agi.v2).bind(agi.config.jsAgiEvents.SERVICE_CALL,function(e,action,payload){try{payload.client.url.indexOf("services.armorgames.com/services/rest/v1/achievements/user")&&payload.client.url.indexOf("method=put")&&jQuery(agi.v2).trigger(agi.config.jsAgiEvents.QUEST_UPDATE,[action,payload])}catch(err){}}),jQuery(agi.v2).bind(agi.config.jsAgiEvents.QUEST_UPDATE,function(e,action,payload){"use strict";if(!(jQuery.browser.msie&&jQuery.browser.version<9)){var messageJson=payload;if("Completed"===messageJson.payload.state){var questThumbnailImg=jQuery("img#"+messageJson.payload.developer_id),questListItem=questThumbnailImg.parent();questListItem.hasClass("completed")||(jQuery.post("/service/user-quest-refresh","earn=1"),0<questThumbnailImg.length&&(questListItem.removeClass("in-progress loading").addClass("completed"),window.questNotifier.show(questThumbnailImg.attr("src"))))}else"In Progress"===messageJson.payload.state?(jQuery("img#"+messageJson.payload.developer_id).parent().removeClass("loading completed in-progress").addClass("in-progress").find(".q-indicator").css("width",messageJson.payload.percent_complete+"%"),jQuery.post("/service/user-quest-refresh")):(void 0!==userAchievementProgress[messageJson.payload.developer_id]&&userAchievementProgress[messageJson.payload.developer_id]<messageJson.payload.percent_complete&&jQuery.post("/service/user-quest-refresh"),userAchievementProgress[messageJson.payload.developer_id]=messageJson.payload.percent_complete)}}),jQuery(function(){"use strict";if(jQuery("#quest-list").length&&jQuery.cookie("logged_in")&&_gameId){console.info("QUESTS","checking quest status");var startTime=(new Date).getTime();jQuery.post("/service/user-quest-data",{gameid:_gameId},function(data){if(data.status){console.info("QUESTS","quests found: "+data.quest_data.results.length);for(var idx=0;idx<data.quest_data.results.length;idx++){var quest=data.quest_data.results[idx];if(console.log(quest),console.info("QUESTS",quest.name,quest.state),"Completed"===quest.state){jQuery('#quest-list li[data-quest-id="'+quest.achievement_id+'"]').attr("class","").addClass("completed");var isoDate=quest.completed_date.replace(" ","T")+" -08:00",questImg=jQuery('#quest-list li[data-quest-id="'+quest.achievement_id+'"] img[data-content]');if(questImg.attr("data-content")){var dataContent=questImg.attr("data-content").replace("\x3c!--complete_date--\x3e","<tr><th>Completed Date:</th><td>"+moment(isoDate).format("MMM Do, YYYY")+"</td></tr>");questImg.attr("data-content",dataContent)}}else jQuery('#quest-list li[data-quest-id="'+quest.achievement_id+'"]').attr("class","").addClass("in-progress").find(".q-indicator").css("width",quest.percent_complete+"%")}}else console.error("QUEST","quest data fail",data.quest_data);_initQuestPopovers()}).error(function(jqXHR,textStatus,errorThrown){_initQuestPopovers(),console.error("QUEST","quest request fail",textStatus,errorThrown)}).complete(function(){var endTime=(new Date).getTime();console.info("QUEST","request time",(endTime-startTime)/1e3)})}else _initQuestPopovers()}),jQuery.extend(!0,agi.v2.config,{$purchaseModal:jQuery("#purchase-modal"),$playPageBody:jQuery("body#page-game,body#page-generic,body#page-settings"),$gameFileArea:jQuery("#gamefilearea"),$prestitials:jQuery("#afg_preloader,#prestitial"),cancelBtnId:"cancel-purchase-btn",revalidateBtnId:"revalidate-purchase-btn",text:{processorStillActive:"It appears that your payment window is still open. Cancelling now may issues with your purchase experience. Are you sure you want to cancel now?",unlockFailed:"Sorry, an error occurred and we were not able to activate your purchase.",processorFailed:"Sorry, the payment processor was not able to confirm your purchase."},errorCode:{PURCH_VERIFY_FAILED:1,PROCESSOR_FAILED:2},analyticPageUrls:{OPEN_STOREFRONT:"/PCv2/open_storefront",CLOSE_STOREFRONT:"/PCv2/close_storefront",SELECT_PRODUCT:"/PCv2/select_product",BEGIN_PURCHASE:"/PCv2/begin_purchase",COMPLETE_PURCHASE:"/PCv2/complete_purchase",ERROR:"/PCv2/error"}}),agi.v2.active_processor=!1,agi.v2.active_processor_window=null,agi.v2.showPurchaseModal=function(contentUrl){"use strict";agi.trackPageview(agi.config.analyticPageUrls.OPEN_STOREFRONT),this.config.$gameFileArea.addClass("gameFileareaHidden"),this.config.$prestitials.addClass("gameFileareaHidden"),this.config.$purchaseModal.modal({remote:contentUrl,keyboard:!1,backdrop:"static"})},agi.v2.setupPurchaseModalDisplay=function(){"use strict";var $product=this.config.$purchaseModal.find(".product");if(1<$product.length)this.config.$purchaseModal.find(".modal-footer-loading").hide().end().find(".modal-footer-select, .shadow").show();else if($product.find(".purchased").length)this.config.$purchaseModal.find(".modal-footer-loading").hide();else{var $select=$product.find(".select").hide();$product.append(jQuery('<div class="single-price" />').html("$"+$select.attr("data-price")+' <span class="currency">USD</span>'));var $checkout=agi.config.$purchaseModal.find(".modal-footer-single-option .checkout").text("");this._showBuyButtons(jQuery.parseJSON($select.attr("data-purchase-buttons")),$checkout),this.config.$purchaseModal.find(".modal-footer-loading").hide().end().find(".modal-footer-single-option").show()}},agi.v2.hidePurchaseModal=function(){"use strict";this.config.$gameFileArea.removeClass("gameFileareaHidden"),this.config.$prestitials.removeClass("gameFileareaHidden"),agi.config.$purchaseModal.modal("hide"),agi.config.$purchaseModal.find(".modal-footer").css("opacity","1")},agi.v2.showPurchaseError=function(message,code){"use strict";var errorPath="/premium-storefront/error?msg="+encodeURIComponent(message)+"&code="+encodeURIComponent(code);if(this.errifyModal(),this.config.$purchaseModal.data("modal"))return agi.console.log("modal visible, updating content"),void this.config.$purchaseModal.find(".modal-body").load(errorPath);agi.console.log("modal not visible, creating new one"),this.showPurchaseModal(errorPath)},agi.v2.errifyModal=function(){"use strict";this.config.$purchaseModal.addClass("modal-error").find(".modal-footer").slideUp("fast")},agi.v2._showBuyButtons=function(buttonData,containerElement){"use strict";var $containerElement=jQuery(containerElement);for(var processorName in buttonData)buttonData.hasOwnProperty(processorName)&&$containerElement.append(jQuery("<div/>").addClass(processorName).html(buttonData[processorName]))},agi.v2._lastPurchasedSku=null,jQuery(agi.v2).bind(agi.config.jsAgiEvents.SHOW_STOREFRONT,function(e,action,payload){"use strict";var sku=payload&&payload.sku?payload.sku:"",parentType=payload&&payload.parent_type?payload.parent_type:"",gameId="website"===parentType?0:window._gameId;agi.v2.showPurchaseModal("/premium-storefront?sku="+encodeURIComponent(sku)+"&gid="+encodeURIComponent(gameId)+"&type="+encodeURIComponent(parentType))}),agi.v2.completePurchase=function(result){"use strict";if(void 0!==result)if(agi.v2.active_processor=!1,result.hasOwnProperty("status")&&result.status){agi.trackPageview(agi.config.analyticPageUrls.COMPLETE_PURCHASE);var payload={sku:result.sku,is_consumable:!1};if(-1!==result.sku.indexOf(":")){var consumableSku=result.sku.split(":");payload.sku_base=consumableSku[0],payload.purchase_quantity=consumableSku[1],payload.is_consumable=!0}this._lastPurchasedSku=result.sku,this.sendToAgi(this.config.flashAgiAction.COMPLETE_PURCHASE,payload)}else agi.trackPageview(agi.config.analyticPageUrls.ERROR),this.showPurchaseError(this.config.text.processorFailed+" "+(result.hasOwnProperty("message")?result.message:"unkown error"),this.config.errorCode.PROCESSOR_FAILED)},agi.config.$playPageBody.on("click","#"+agi.config.cancelBtnId,function(e){"use strict";e.preventDefault(),agi.console.log("User attempting to cancel purchase"),!agi.v2.active_processor||window.confirm(agi.config.text.processorStillActive)?(agi.trackPageview(agi.config.analyticPageUrls.CLOSE_STOREFRONT),agi.v2.hidePurchaseModal(),agi.v2.sendToAgi(agi.config.flashAgiAction.CANCEL_PURCHASE,null)):agi.console.log("Active processor detected. User choose to call off their cancel action")}),jQuery(agi.v2).bind(agi.config.jsAgiEvents.PURCH_VERIFY_FAILED,function(e,action,payload){"use strict";agi.trackPageview(agi.config.analyticPageUrls.ERROR);var message=payload&&payload.message?payload.message:"";console.error("PURCH_VERIFY_FAILED",message),agi.v2.showPurchaseError(this.config.text.unlockFailed,this.config.errorCode.PURCH_VERIFY_FAILED)}),jQuery(agi.v2).bind(agi.config.jsAgiEvents.HIDE_STOREFRONT,function(e,action,payload){"use strict";agi.v2.hidePurchaseModal()}),agi.config.$purchaseModal.on("hidden",function(){"use strict";agi.v2.active_processor=!1,agi.config.$purchaseModal.data("modal").$element.removeData().removeClass("modal-error").find(".modal-body").html('<div class="loader"/>').end().find(".modal-footer,.shadow").hide().end().find(".modal-footer-loading").show()}),agi.config.$playPageBody.on("submit",".checkout .paypal form",function(){"use strict";if(agi.v2.active_processor_window)return agi.v2.active_processor_window.focus(),!1;agi.trackPageview(agi.config.analyticPageUrls.BEGIN_PURCHASE);var $purchaseModal=agi.config.$purchaseModal,$modalBody=$purchaseModal.find(".modal-body");$purchaseModal.data("storefront-product-data",$modalBody.html()),$purchaseModal.find(".modal-footer").css("opacity",0).end().find(".shadow").hide(),$modalBody.html('<div class="loader waiting-for-processor">Waiting for payment processor...<div class="footnote">If you do not see a purchase pop-up window then try disabling any pop-up blockers, ad blockers or firewalls. If you have any issues <a href="/purchase-support" target="_blank">please contact us</a>.</div></div>').scrollTop(0),jQuery(this).attr("target","paypal_purchase_window");var left=Math.max(parseInt(screen.width/2-487.5,10),0),top=Math.max(parseInt(screen.height/2-437.5,10),0);agi.v2.active_processor_window=window.open("","paypal_purchase_window","width=975, height=875, top="+top+", left="+left),agi.v2.active_processor="paypal",agi.v2.active_processor_listener=function(event){if(void 0!==agi.v2.active_processor_interval&&clearInterval(agi.v2.active_processor_interval),-1!==event.origin.indexOf("armorgames.com")){var json;try{json=JSON.parse(event.data),["status","message","sku"].forEach(function(p){if(!json.hasOwnProperty(p))throw"JSON data is missing property: "+p})}catch(e){return void agi.console.log(e)}agi.v2.completePurchase(json),window.removeEventListener("message",this)}else agi.console.log("Ignoring incoming event from: "+event.origin)},window.addEventListener("message",agi.v2.active_processor_listener,!1),agi.v2.active_processor_interval=setInterval(function(){agi.v2.active_processor_window&&agi.v2.active_processor_window.postMessage("data please","*")},250);var windowCheck=setInterval(function(){try{if(agi.v2.active_processor_window.name&&-1!==agi.v2.active_processor_window.name.indexOf("::")){var nameData=agi.v2.active_processor_window.name.split("::");agi.v2.active_processor_window.name=nameData[0],agi.v2.completePurchase(JSON.parse(nameData[1]))}}catch(err){return!0}agi.v2.active_processor_window.closed&&(agi.v2.active_processor&&(agi.console.log("Close window was premature"),agi.v2.active_processor=!1,$modalBody.html($purchaseModal.data("storefront-product-data")),$purchaseModal.find(".modal-footer").css("opacity",1).end().find(".shadow").show()),clearInterval(windowCheck),agi.v2.active_processor_window=null)},250);return!0}),agi.config.$playPageBody.on("click","#purchase-modal .select",function(){"use strict";agi.trackPageview(agi.config.analyticPageUrls.SELECT_PRODUCT);var $this=jQuery(this);agi.config.$purchaseModal.find(".selected").removeClass("selected").addClass("select").text("select").end().find(".product.active").removeClass("active"),$this.removeClass("select").addClass("selected").text("selected").closest("li").addClass("active"),agi.config.$purchaseModal.find(".cart .thumb").attr("src",$this.attr("data-image")),agi.config.$purchaseModal.find(".cart .name").text($this.attr("data-name")),agi.config.$purchaseModal.find(".cart").find(".free").hide().end().find(".price").removeClass("canceled").find(".value").text($this.attr("data-price"));var $checkout=agi.config.$purchaseModal.find(".checkout").text("");agi.v2._showBuyButtons(jQuery.parseJSON($this.attr("data-purchase-buttons")),$checkout);var $selectedModalFooter=agi.config.$purchaseModal.find(".modal-footer-selected");$selectedModalFooter.not(":visible")&&(agi.config.$purchaseModal.find(".modal-footer").hide(),$selectedModalFooter.show())}),agi.v2.stripe_token=null,agi.v2.stripe_sku=null,agi.v2.stripe_handler=StripeCheckout.configure({key:_stripe_data.key,email:_stripe_data.email,image:"/images/logo-stripe.png",currency:"USD",locale:"auto",alipay:!1,bitcoin:!1,zipCode:!0,token:function(token){agi.v2.stripe_token=token},closed:function(){if(null==agi.v2.stripe_token){var $purchaseModal=agi.config.$purchaseModal;$purchaseModal.find(".modal-body").html($purchaseModal.data("storefront-product-data")),$purchaseModal.find(".modal-footer").css("opacity",1).end(),1<$purchaseModal.find(".product").length&&$purchaseModal.find(".shadow").show(),agi.v2.stripe_sku=null,agi.v2.stripe_token=null}else jQuery.post("/service/stripe-payment-handler",{ajax:1,sku:agi.v2.stripe_sku,token:JSON.stringify(agi.v2.stripe_token)}).done(function(data,textStatus,jqXHR){data=data||{status:!1,sku:null,message:""},agi.v2.completePurchase({status:!!data.hasOwnProperty("status")&&data.status,sku:data.hasOwnProperty("sku")?data.sku:null,message:data.hasOwnProperty("message")?data.message:""})}).fail(function(jqXHR,textStatus,errorThrown){agi.v2.completePurchase({status:!1,sku:agi.v2.stripe_sku,message:errorThrown})}).always(function(){agi.v2.stripe_sku=null,agi.v2.stripe_token=null});agi.config.$purchaseModal.show(),jQuery("body.stripe-checkout-actv .modal-backdrop").show(),jQuery("body").removeClass("stripe-checkout-actv")}}),agi.config.$playPageBody.on("click",".checkout .stripe button",function(event){"use strict";var $this=jQuery(this);if(agi.v2.stripe_sku=$this.attr("data-sku"),agi.v2.active_processor_window)return agi.v2.active_processor_window.focus(),!1;var $purchaseModal=agi.config.$purchaseModal,$modalBody=$purchaseModal.find(".modal-body");return $purchaseModal.data("storefront-product-data",$modalBody.html()),jQuery("body").addClass("stripe-checkout-actv"),setTimeout(function(){$purchaseModal.hide().find(".modal-footer").css("opacity",0).end().find(".shadow").hide(),jQuery("body.stripe-checkout-actv .modal-backdrop").hide(),$modalBody.html('<div class="loader waiting-for-processor">Processing your payment...</div></div>')},1e3),agi.v2.stripe_handler.open({name:"Armor Games",description:$this.attr("data-desc"),amount:parseInt($this.attr("data-price"))}),agi.trackPageview(agi.config.analyticPageUrls.BEGIN_PURCHASE),event.preventDefault(),!1});